name: üì∫ EPG Crawler (Boomerang)

on:
  schedule:
    - cron: "0 18 * * *"  # 01:00 s√°ng gi·ªù H√† N·ªôi (UTC+7)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml

      - name: üï∏Ô∏è Crawl Boomerang EPG
        run: |
          python << 'EOF'
          import requests, datetime, re
          from bs4 import BeautifulSoup

          def fetch_epg(date_str):
              url = f"https://info.msky.vn/vn/Boomerang.html?date={date_str}"
              r = requests.get(url, timeout=20)
              r.encoding = "utf-8"
              soup = BeautifulSoup(r.text, "lxml")

              programmes = []
              for tr in soup.select("table tbody tr"):
                  tds = tr.find_all("td")
                  if len(tds) >= 2:
                      start = tds[0].get_text(strip=True)
                      title = tds[1].get_text(strip=True)
                      if not re.match(r'^\d{2}:\d{2}$', start):
                          continue
                      programmes.append((start, title))
              return programmes

          today = datetime.date.today()
          nextday = today + datetime.timedelta(days=1)

          all_counts = {}
          xml = ['<?xml version="1.0" encoding="utf-8"?>',
                 '<tv generator-info-name="lps_crawler">']

          for d in [today, nextday]:
              date_str = d.strftime("%d/%m/%Y")
              progs = fetch_epg(date_str)
              all_counts[d.strftime("%Y-%m-%d")] = len(progs)

              for start, title in progs:
                  start_fmt = datetime.datetime.strptime(
                      f"{d.strftime('%Y-%m-%d')} {start}", "%Y-%m-%d %H:%M"
                  ).strftime("%Y%m%d%H%M%S +0700")
                  xml.append(f'<programme start="{start_fmt}" channel="Boomerang">')
                  xml.append(f'  <title lang="vi">{title}</title>')
                  xml.append('</programme>')

          xml.append('</tv>')
          with open("boomerang.xml", "w", encoding="utf-8") as f:
              f.write("\n".join(xml))

          # L∆∞u s·ªë l∆∞·ª£ng ch∆∞∆°ng tr√¨nh t·ª´ng ng√†y ƒë·ªÉ hi·ªÉn th·ªã
          with open("counts.txt", "w") as f:
              for k, v in all_counts.items():
                  f.write(f"{k}={v}\n")

          print("‚úÖ EPG file created successfully.")
          EOF

      - name: üíæ Commit and push XML
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add boomerang.xml counts.txt
          git commit -m "Update boomerang.xml: $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

      - name: üßæ Report summary
        shell: bash
        run: |
          TODAY=$(date '+%Y-%m-%d')
          TOMORROW=$(date -d "+1 day" '+%Y-%m-%d')
          COUNT_TODAY=$(grep "$TODAY" counts.txt | cut -d'=' -f2)
          COUNT_TOMORROW=$(grep "$TOMORROW" counts.txt | cut -d'=' -f2)
          TOTAL=$((COUNT_TODAY + COUNT_TOMORROW))

          echo "## üïí EPG Crawl Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date (Hanoi):** $(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Today ($TODAY):** $COUNT_TODAY programmes" >> $GITHUB_STEP_SUMMARY
          echo "- **Tomorrow ($TOMORROW):** $COUNT_TOMORROW programmes" >> $GITHUB_STEP_SUMMARY
          echo "- **Total parsed:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** [info.msky.vn](https://info.msky.vn/vn/Boomerang.html)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **[EPG file updated successfully](https://github.com/${{ github.repository }}/blob/main/boomerang.xml)**" >> $GITHUB_STEP_SUMMARY
          
